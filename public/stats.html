<!DOCTYPE html>
<html lang="en">
<head>
<link rel="icon" type="image/png" href="assets/favicon.png">

  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Test Statistics</title>
  <link rel="stylesheet" href="assets/style.css">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
    import { getFirestore, collection, getDocs } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";
    const firebaseConfig = {
      apiKey: "AIzaSyAOM12PX5IwlQf5MFVvmMK3JjJV3w5hdLk",
      authDomain: "mental-health-test-618f9.firebaseapp.com",
      projectId: "mental-health-test-618f9",
      storageBucket: "mental-health-test-618f9.firebasestorage.app",
      messagingSenderId: "1048688157283",
      appId: "1:1048688157283:web:397d42ea4c838e8f654e56",
      measurementId: "G-SRV3QP9P3J"
    };
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    window._db = db;
    window._getDocs = getDocs;
    window._collection = collection;
  </script>
</head>
<body>
  <nav>
    <ul>
      <li><a href="index.html">Home</a></li>
      <li><a href="info.html">Info</a></li>
      <li><a href="test.html">Take the Test</a></li>
      <li><a href="result.html">Results</a></li>
      <li><a class="active" href="stats.html">Statistics</a></li>
    </ul>
  </nav>
  <div class="container results-card">
    <h1>Data Explorer / Test Statistics</h1>
    <form id="stats-filter" class="stats-filter">
      <label>Country:
  <select name="country" id="country">
    <option value="">All</option>
              <option value="Argentina">Argentina</option>
              <option value="Australia">Australia</option>
              <option value="Azerbaijan">Azerbaijan</option>
              <option value="Belgium">Belgium</option>
              <option value="Brazil">Brazil</option>
              <option value="Canada">Canada</option>
              <option value="China">China</option>
              <option value="Egypt">Egypt</option>
              <option value="Finland">Finland</option>
              <option value="France">France</option>
              <option value="Germany">Germany</option>
              <option value="Greece">Greece</option>
              <option value="India">India</option>
              <option value="Italy">Italy</option>
              <option value="Japan">Japan</option>
              <option value="Kazakhstan">Kazakhstan</option>
              <option value="Mexico">Mexico</option>
              <option value="Netherlands">Netherlands</option>
              <option value="New Zealand">New Zealand</option>
              <option value="Poland">Poland</option>
              <option value="Portugal">Portugal</option>
              <option value="Saudi Arabia">Saudi Arabia</option>
              <option value="South Africa">South Africa</option>
              <option value="South Korea">South Korea</option>
              <option value="Spain">Spain</option>
              <option value="Sweden">Sweden</option>
              <option value="Turkey">Turkey</option>
              <option value="Ukraine">Ukraine</option>
              <option value="United Kingdom">United Kingdom</option>
              <option value="United States">United States</option>
              <option value="Vietnam">Vietnam</option>
  </select>
</label>

      <label>Age:
        <select name="age" id="ageGroup">
          <option value="">All</option>
          <option value="18-25">18–25</option>
          <option value="26-35">26–35</option>
          <option value="36-50">36–50</option>
          <option value="51+">51+</option>
        </select>
      </label>
      <label>Gender:
        <select name="gender" id="gender">
          <option value="">All</option>
          <option value="Male">Male</option>
          <option value="Female">Female</option>
          <option value="Other">Other</option>
        </select>
      </label>
     <label>Occupation:
  <select name="occupation" id="occupation">
    <option value="">All</option>
    <option value="Student">Student</option>
    <option value="IT Specialist / Programmer">IT Specialist / Programmer</option>
    <option value="Teacher / Educator">Teacher / Educator</option>
    <option value="Doctor / Medical Worker">Doctor / Medical Worker</option>
    <option value="Engineer">Engineer</option>
    <option value="Scientist / Researcher">Scientist / Researcher</option>
    <option value="Manager / Office Worker">Manager / Office Worker</option>
    <option value="Sales / Marketing">Sales / Marketing</option>
    <option value="Service Industry">Service Industry</option>
    <option value="Driver / Transportation">Driver / Transportation</option>
    <option value="Construction Worker">Construction Worker</option>
    <option value="Government Employee">Government Employee</option>
    <option value="Unemployed">Unemployed</option>
    <option value="Retired">Retired</option>
    <option value="Self-Employed / Entrepreneur">Self-Employed / Entrepreneur</option>
    <option value="Other">Other</option>
  </select>
</label>
      <button type="submit" class="button">Apply Filter</button>
    </form>
    <div style="max-width:850px; margin:32px auto 12px;">
      <canvas id="avgChart" height="100"></canvas>
    </div>
    <div id="stats-summary"></div>
<table class="stats-table" id="stats-table"></table>
<div id="no-data" class="no-data" style="display:none"></div>
<div style="max-width:900px; margin:32px auto;">
  <canvas id="avgChart" height="120"></canvas>
</div>

  <script>
    if (!localStorage.getItem('mh_answers')) {
      window.location.href = 'test.html';
    }

let allResults = [];
const catList = ["Burnout","Bipolar","Social","Eating","OCD","Panic","Anxiety","Depression","Substance","SelfHarm"];
let avgChart = null;


let allCountries = [];
let allOccupations = [];

async function fetchResults() {
  const db = window._db, getDocs = window._getDocs, collection = window._collection;
  const qSnap = await getDocs(collection(db,"mh_results"));
  allResults = [];
  const countriesSet = new Set();
  const occupationsSet = new Set();
  qSnap.forEach(doc=>{
    const data = doc.data();
    if (!data || !data.user || !data.categories) return;
    if (data.user.country && data.user.country.trim() && data.user.country !== "Other") {
      countriesSet.add(data.user.country.trim());
    }
    if (data.user.occupation && data.user.occupation.trim()) {
      occupationsSet.add(data.user.occupation.trim());
    }
    allResults.push({...data.user, categories: data.categories });
  });
  allCountries = Array.from(countriesSet).sort();
  allOccupations = Array.from(occupationsSet).sort();
  updateCountrySelect();
  updateOccupationSelect();
  applyFilter();
}

function updateCountrySelect() {
  const sel = document.getElementById('country');
  sel.innerHTML = '<option value="">All</option>';
  allCountries.forEach(c=>{
    sel.innerHTML += `<option value="${c}">${c}</option>`;
  });
}

function updateOccupationSelect() {
  const sel = document.getElementById('occupation');
  sel.innerHTML = '<option value="">All</option>';
  allOccupations.forEach(o=>{
    sel.innerHTML += `<option value="${o}">${o}</option>`;
  });
}

function applyFilter() {
  const fCountry = document.getElementById('country').value.trim();
  const fAge = document.getElementById('ageGroup').value;
  const fGender = document.getElementById('gender').value.trim();
  const fOcc = document.getElementById('occupation').value.trim();
  let filtered = allResults.filter(r=>{
    let ok = true;
    // для country, occupation і gender ігноруємо пробіли і порівнюємо без регістру (бо select дає правильний кейс)
    if (fCountry && (r.country||"").trim() !== fCountry) ok = false;
    if (fGender && (r.gender||"").trim() !== fGender) ok = false;
    if (fOcc && (r.occupation||"").trim() !== fOcc) ok = false;
    if (fAge) {
      let age = parseInt(String(r.age).trim(),10); // на всяк випадок, якщо age це string
      if (fAge === "18-25" && !(age >=18 && age<=25)) ok=false;
      if (fAge === "26-35" && !(age >=26 && age<=35)) ok=false;
      if (fAge === "36-50" && !(age >=36 && age<=50)) ok=false;
      if (fAge === "51+" && age<51) ok=false;
    }
    return ok;
  });
  console.log('Filtered results:', filtered.length, filtered); // можна прибрати після тесту
  drawStats(filtered);
  drawAvgChart(filtered);
}

function drawStats(arr) {
  const noDataDiv = document.getElementById('no-data');
  const summary = document.getElementById('stats-summary');
  const table = document.getElementById('stats-table');
  table.innerHTML = '';
  if (!arr.length) {
    noDataDiv.style.display = 'block';
    noDataDiv.innerHTML = "No data for this group yet.";
    summary.innerHTML = '';
    return;
  }
  noDataDiv.style.display = 'none';

  // Show summary
  const fCountry = document.getElementById('country').value;
  const fAge = document.getElementById('ageGroup').value;
  const fGender = document.getElementById('gender').value;
  const fOcc = document.getElementById('occupation').value;
  summary.innerHTML = `
    <b>Sample size:</b> ${arr.length}<br>
    <b>Filters:</b>
      Country: ${fCountry || "All"},
      Age: ${fAge || "All"},
      Gender: ${fGender || "All"},
      Occupation: ${fOcc || "All"}
  `;

  // Table
  let head = `<tr>
    <th>Category</th>
    <th>Average</th>
  </tr>`;
  let rows = '';
  catList.forEach(cat=>{
    let vals = arr.map(u=>{
      let c = u.categories.find(x=>x.key === cat || x.label === cat);
      return c?c.user:null;
    }).filter(x=>x!=null);
    let avg = vals.length ? Math.round(vals.reduce((a,b)=>a+b,0)/vals.length*10)/10 : '—';
    rows += `<tr>
      <td>${cat}</td>
      <td>${avg === 0 ? '0%' : (avg === '—' ? '—' : avg + "%")}</td>
    </tr>`;
  });
  table.innerHTML = head+rows;
}


function drawAvgChart(arr) {
  if (!arr.length) { if (avgChart && avgChart.destroy) avgChart.destroy(); return; }
  let avgs = [];
  catList.forEach(cat=>{
    let vals = arr.map(u=>{
      let c = u.categories.find(x=>x.key === cat || x.label === cat);
      return c?c.user:null;
    }).filter(x=>x!=null);
    let avg = vals.length ? Math.round(vals.reduce((a,b)=>a+b,0)/vals.length*10)/10 : 0;
    avgs.push(avg);
  });
  if (avgChart && avgChart.destroy) avgChart.destroy();
  avgChart = new Chart(document.getElementById('avgChart').getContext('2d'), {
    type: 'bar',
    data: {
      labels: catList,
      datasets: [
        {
          label: 'Average',
          data: avgs,
          backgroundColor: '#5b88ff'
        }
      ]
    },
    options: {
      responsive: true,
      plugins: {
        legend: { display: false },
        title: {
          display: true,
          text: 'Averages by category',
          font: { size: 16 }
        }
      },
      scales: {
        y: { beginAtZero: true, max: 100, title: { display: true, text: "%" } }
      }
    }
  });
}


    document.getElementById('stats-filter').addEventListener('submit',e=>{
      e.preventDefault();
      applyFilter();
    });

    window.addEventListener('DOMContentLoaded', ()=>{
      setTimeout(fetchResults,400);
    });
  </script>
</body>
</html>
